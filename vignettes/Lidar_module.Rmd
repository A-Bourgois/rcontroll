---
title: "Lidar module"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Lidar module}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6,
  fig.width = 6
)
```

This vignette gives a quick example of a simple workflow to produce discrete lidar LAS and full waveform GEDI lidar from TROLL simulation.

# Setup

We will use `rcontroll`.

```{r libs}
suppressMessages(library(dplyr))
library(tidyr)
library(ggplot2)
suppressMessages(library(rcontroll))
library(lidR)
library(plot3D)
library(terra)
library(sf)
library(rGEDI)
```

# Lidar simulation

A Lidar slot is added to TROLL simulation if lidar simulation parameters are specified.

```{r}

sim <- troll(name = "test",path = getwd(),
             global = generate_parameters(cols = 100, rows = 100,
                                          iterperyear = 12, nbiter = 6),
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar,
             lidar = generate_lidar(mean_beam_pc = 70,
                                    sd_beam_pc = 20,
                                    klaser_pc = 0.63,
                                    transmittance_laser = 0.1,
                                    iter_pointcloud_generation = 1),
             verbose = FALSE)

# information to read in file

dir_current = sim@path

```

The generated lidar simulation provide standard paramters to simulate las. But the iter of the lidar simulation must be specified using : iter_pointcloud_generation

The las file is produced in the same folder as other outputs files.

It can be read as a typical las file.

```{r}
# read files
file_pointcloud = file.path(dir_current,"test_0.las")

# read in file
pointcloud = readLAS(file_pointcloud)

summary(pointcloud)

las_check(pointcloud)

# rGEDI needs the las files reexported temporarily (maybe to update format)
file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","test_0.las")
dir.create(file.path(dir_current,"processing_waveforms"))

ground_troll <- rast(nrows=100, ncols=100, nlyrs=1, xmin=0, xmax=100, 
                     ymin=0, ymax=100, vals = 0)

lasnorm <- normalize_height(pointcloud, ground_troll)

writeLAS(lasnorm, file_pointcloud_lidR)
```

The rGEDI package allows to process ALS las data to simulate a Full Waveform signal equivalent to data collected by GEDI Device on ISS.

```{r}
# rGEDI is not on CRAN anymore, github installation did not work for me, but it worked with a download of the last available CRAN version (https://cran.r-project.org/src/contrib/Archive/rGEDI/)
# install.packages(pkgs="~/Downloads/rGEDI_0.1.11.tar.gz", type="source", repos=NULL) # worked
# library(devtools)
# devtools::install_git("https://github.com/carlos-alberto-silva/rGEDI", dependencies = TRUE) # did not work


# now generate GEDI footprint
# cf. https://github.com/carlos-alberto-silva/rGEDI
# Extracting plot center geolocations

file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","test_0.las")

pointcloud = readLAS(file_pointcloud_lidR)

# we calculate waveform for a specific point within the simulated extent
wv_x_pointcloud = 50
wv_y_pointcloud = 50

# remove files, as gediWFSimulator does not overwrite
if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))

wf_pointcloud = gediWFSimulator(input = file_pointcloud_lidR, output = file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"), coords = c(wv_x_pointcloud, wv_y_pointcloud))

waveform_extent = st_point(x = c(wv_x_pointcloud, wv_y_pointcloud), dim = "XYZ") |> 
  st_buffer(dist = 12.5)# bit awkward, using terra, then sf
pointcloud_clipped = clip_roi(pointcloud, waveform_extent)

par(mfrow=c(1,2), mar=c(4,4,1,1), oma=c(1,1,1,1),cex.axis = 1.2)
scatter3D(pointcloud_clipped@data$X,pointcloud_clipped@data$Y,pointcloud_clipped@data$Z,pch = 16,colkey = FALSE, main="ALS simulation (realistic extinction)",
          cex = 0.5,bty = "u",col.panel ="gray90",phi = 30,alpha=1,theta=45,
          col.grid = "gray50", xlab="UTM Easting (m)", ylab="UTM Northing (m)", zlab="Elevation (m)")

plot(wf_pointcloud, relative=TRUE, polygon=TRUE, type="l", lwd=2, col="forestgreen",
     xlab="", ylab="Elevation (m)", ylim=c(0,70))

```

```{r}
wf_Paracou_metrics<-gediWFMetrics(input=wf_pointcloud,
                                  outRoot=normalizePath(file.path(dir_current,
                                                                  "processing_waveforms", 
                                                                  "Paracou")),
                                  ground = 0)
close(wf_pointcloud)
wf_Paracou_metrics
```


Using this workflow, a TROLL forest is now associated to a simulated FW signal and las point cloud.

On the other hand, the 3D LAI Field can be converted to FW according to (Knapp et al., 2021).

```{r}
library(tidyverse)

test_0_LAI3D<- read.delim(paste0(dir_current,"/test_0_LAI.txt"))

LAI_WF <- test_0_LAI3D |>  mutate(LAD = LAI3D - lead(LAI3D)) |>  
  filter(LAD>0 | h==0) |> mutate(Intensity = if_else(h==0, 
                                                     exp(-0.2*LAI3D - ((row - 50)^2 + (col - 50)^2)/( 2 * 5.5^2))/2.5,
                                                     exp(-0.2*LAI3D - ((row - 50)^2 + (col - 50)^2)/( 2 * 5.5^2)))) |> 
  group_by(h) |>  summarize(I = sum(Intensity)) |> ungroup() |>  mutate(I = I/sum(I))

LAI_WF_sample <- sample(LAI_WF$h,size = 100000, prob = LAI_WF$I,replace = TRUE) |> density(kernel = "gaussian")



ggplot() + geom_line(data = tibble(h = LAI_WF_sample$x,WF = LAI_WF_sample$y),aes(x = h, y=WF)) + 
  geom_line(data = LAI_WF,aes(x = h, y = I/sum(I)), col = "red") + 
  coord_flip() + theme_bw()


```

# Calibration lidar module

The calibration method is based on Paracou 2016 inventory and lidar campaign. These data were used to simulate TROLL simulation with Canopy Constructor V0.1.0 (available [here](https://github.com/fischer-fjd/CanopyConstructor)).

Basically the canopy constructor algorithm reconstruct spatially 3D canopy forest using Canopy Height Model (CHM) and a redispatched inventory (resolution : 1m). Futher description in (Fischer *et al.*, 2020).

This reconstruction provides a compatible inventory with rcontroll. The lidar module provide an option `iter_pointcloud_generation` to select at which iteration the lidar simulation is generated. At `iter_pointcloud_generation = 0` the lidar simulation is obtain from forest input without any modification.

The calibration method is a matching method between Full Waveform generated from real lidar ($FW_{obs}$) and simulated ones ($FW_{sim}$) according to lidar simulator parameters (`klaser_pc` and `transmittance_laser`).

First we import and process obs las data to normalize using DTM.

```{r}
file_pointcloud <- "~/BETA/backup/Data/Paracou16_2019_25m_Buffer.laz"
pointcloud <- readLAS(file_pointcloud)
projection(pointcloud) <- "EPSG:32622"

pointcloud_clean <- filter_poi(pointcloud, abs(ScanAngleRank)<20)

dtm <- rast("~/BETA/backup/SIG/GuyaFor/Paracou_2015.tif")
lasnorm <- normalize_height(pointcloud_clean, dtm)
dsm <- grid_canopy(lasnorm , res = 2, pitfree(c(0,2,5,10,15), c(0, 1)))
dsm[dsm<0] <- 0
dsm <- rast(dsm)
writeLAS(lasnorm, "~/BETA/backup/Data/Paracou16_2019_Buff25m_Norm.laz")

file_pointcloud <- "~/BETA/backup/Data/Paracou_2016_Plots_25m_Buffer.laz"
pointcloud <- readLAS(file_pointcloud)
projection(pointcloud) <- "EPSG:32622"
pointcloud_clean <- filter_poi(pointcloud, abs(ScanAngleRank)<20)
lasnorm <- normalize_height(pointcloud, dtm)
writeLAS(filter_poi(lasnorm,Z < 50), "~/BETA/backup/Data/Paracou_2016_Plots_Buff25m_Norm.laz")

rm(list =  ls())
```

After this cleaning step, the las data are processed with rGEDI to simulate Full waveform.

We need to define shooting spots within experimental site plots:

```{r}
Paracou_plots <- vect("~/BETA/backup/SIG/Plots/Paracou_plots.shp")
crs(Paracou_plots) <- "EPSG:32622"
Paracou_plots <- Paracou_plots |> st_as_sf() |> filter(N_PARCELLE != 16) |> st_geometry() |> st_union() |>  st_buffer(-20)

rotang <- -15.7
rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)
tran <- function(geo, ang, center) (geo - center) * rot(ang * pi / 180) + center

# center <- Paracou_plots |> st_union() |> st_centroid()
# grd <- st_make_grid(tran(Paracou_plots, -rotang, center), cellsize = 35)
# grd_Paracou <- tran(grd, rotang, center) |> st_set_crs("EPSG:32622")
# grd_Paracou_clipped <- grd_Paracou |>
#   st_centroid() |>
#   st_intersection(Paracou_plots)

grd_Paracou_clipped <- st_make_grid(Paracou_plots, cellsize = 35) |>
  st_set_crs("EPSG:32622")|>
  st_centroid() |>
  st_intersection(Paracou_plots)

grd_Paracou_clipped <- grd_Paracou_clipped |> st_as_sf() |> 
  mutate(Xutm = st_coordinates(grd_Paracou_clipped)[,1],Yutm = st_coordinates(grd_Paracou_clipped)[,2])

Paracou_plots <- vect("~/BETA/backup/SIG/Plots/Paracou_plots.shp")
crs(Paracou_plots) <- "EPSG:32622"
Paracou_plots <- Paracou_plots |> st_as_sf() |> filter(N_PARCELLE != 16)
grd_Paracou_clipped <- grd_Paracou_clipped |> st_join(Paracou_plots |> select(N_PARCELLE))
Paracou_plots <- Paracou_plots |> st_geometry() |> st_union()

ggplot() + 
  geom_sf(data = Paracou_plots, color = "black") + 
  geom_sf(data = grd_Paracou_clipped$x |> st_buffer(12.5), color= "red")
readr::write_tsv(grd_Paracou_clipped,"~/Documents/Calib_lidar/grd_Paracou_clipped.tsv")
rm(list =  ls())
``` 

Test for 1st point :
```{r}
dir_current <-"~/BETA/backup/Data"
file_pointcloud <- "~/BETA/backup/Data/Paracou_2016_Plots_Buff25m_Norm.laz"
dir.create(file.path(dir_current,"processing_waveforms"))

file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","Paracou_2016_Plots_Buff25m_Norm.las")

pointcloud <- readLAS(file_pointcloud_lidR)
projection(pointcloud) <- "EPSG:32622"

wv_x_pointcloud = grd_Paracou_clipped$Xutm[10]
wv_y_pointcloud = grd_Paracou_clipped$Yutm[10]

# remove files, as gediWFSimulator does not overwrite
if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))
if(file.exists(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))) file.remove(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))

wf_pointcloud <-  gediWFSimulator(input = normalizePath(file_pointcloud_lidR), 
                                  output = paste0(normalizePath(file.path(dir_current,
                                                                          "processing_waveforms")),
                                                  "/gediWF_simulation.h5"), 
                                  coords = c(wv_x_pointcloud, wv_y_pointcloud))

waveform_extent = st_point(x = c(wv_x_pointcloud, wv_y_pointcloud), dim = "XYZ") |> 
  st_buffer(dist = 12.5)# bit awkward, using terra, then sf
pointcloud_clipped = clip_roi(pointcloud, waveform_extent)
```
Processed data are plotted using rGEDI package.
```{r}
par(mfrow=c(1,2), mar=c(4,4,1,1), oma=c(1,1,1,1),cex.axis = 1.2)
scatter3D(pointcloud_clipped@data$X,pointcloud_clipped@data$Y,pointcloud_clipped@data$Z,pch = 16,colkey = FALSE, main="",
          cex = 0.5,bty = "u",col.panel ="gray90",phi = 30,alpha=1,theta=45,
          col.grid = "gray50", xlab="UTM Easting (m)", ylab="UTM Northing (m)", zlab="Elevation (m)")

plot(wf_pointcloud, relative=TRUE, polygon=TRUE, type="l", lwd=2, col="forestgreen",
     xlab="", ylab="Elevation (m)", ylim=c(0,50))
```

Metrics can be derived from simulated full waveform :
```{r}
wf_Paracou_metrics<-gediWFMetrics(input=wf_pointcloud,
                                  outRoot=normalizePath(file.path(dir_current,
                                                                  "processing_waveforms", 
                                                                  "Paracou")),
                                  ground = 0)
wf_Paracou_metrics$`wave ID` <- 0
close(wf_pointcloud)
wf_Paracou_metrics
```

Using real ALS data acquired on experimental site, we will simulate full waveform for each shooting spot.
```{r}
library(purrr)
dir_current <-"~/BETA/backup/Data"
file_pointcloud <- "~/BETA/backup/Data/Paracou_2016_Plots_Buff25m_Norm.laz"
dir.create(file.path(dir_current,"processing_waveforms"))

file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","Paracou_2016_Plots_Buff25m_Norm.las")

pointcloud_CC <- readLAS(file_pointcloud_lidR)
projection(pointcloud_CC) <- "EPSG:32622"

writeLAS(filter_poi(pointcloud_CC, Z > 5),file.path(dir_current,"processing_waveforms","Paracou_2016_Plots_Buff25m_Norm.las"))

write.table(grd_Paracou_clipped |> 
              st_drop_geometry() |> mutate(waveID = paste0(N_PARCELLE,"_",row_number())) |> 
              rename("X" = "Xutm", "Y" = "Yutm") |> 
              select(X,Y,waveID), file = file.path(dir_current,"processing_waveforms","list_coords_Paracou.txt"),
            row.names = FALSE,col.names = FALSE)

# remove files, as gediWFSimulator does not overwrite
if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))
if(file.exists(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))) file.remove(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))

wf_pointcloud <-  gediWFSimulator(input = normalizePath(file.path(dir_current,
                                                                  "processing_waveforms",
                                                                  "Paracou_2016_Plots_Buff25m_Norm.las")), 
                                  output = paste0(normalizePath(file.path(dir_current,
                                                                          "processing_waveforms")),
                                                  "/gediWF_simulation.h5"),
                                  listCoord = normalizePath(file.path(dir_current,"processing_waveforms","list_coords_Paracou.txt")),
                                  maxScanAng = 20,checkCover = TRUE)

wf_Paracou_metrics<-gediWFMetrics(input=wf_pointcloud,
                                  outRoot=normalizePath(file.path(dir_current,
                                                                  "processing_waveforms", 
                                                                  "Paracou")))

close(wf_pointcloud)
rm(wf_pointcloud)

if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))

colnames(wf_Paracou_metrics) <- gsub(colnames(wf_Paracou_metrics),pattern = " ",replacement = "_")
wf_Paracou_metrics$true_ground <- wf_Paracou_metrics$ground_slope <- 0

readr::write_tsv(wf_Paracou_metrics, file.path(dir_current,"processing_waveforms","Paracou_metric.tsv"))
rm(wf_Paracou_metrics)
```

Extracted metric are reformated :

```{r}
dir_current <-"~/BETA/backup/Data"
wf_Paracou_metrics <- readr::read_tsv(normalizePath(file.path(dir_current,"processing_waveforms","Paracou_metric.tsv"))) |> 
  separate(col = wave_ID, into = c("Plot","waveID_Plot"),remove = FALSE) |> mutate(Plot = as.numeric(Plot), waveID_Plot = as.numeric(waveID_Plot))

coord_carre_parcelle_paracou <- readxl::read_excel("~/Nextcloud/Model/TROLL/Paracou_posterior/coord_carre_parcelle_paracou.xlsx")
colnames(coord_carre_parcelle_paracou) <- gsub(colnames(coord_carre_parcelle_paracou),pattern = " ",replacement = "_")

load("~/Nextcloud/Model/TROLL/Paracou_posterior/trees_basic_withcoord.RData")

trees_basic <- trees_basic_withcoord |> 
  left_join(coord_carre_parcelle_paracou |> 
              rowwise() |> 
              mutate(Xrel_plot = min(no_x,ne_x,so_x,se_x), 
                     Yrel_plot = min(no_y,ne_y,so_y,se_y)) |> 
              select(Parc,Xrel_plot,Yrel_plot), 
            by = c("plot_code" = "Parc")) |> 
  mutate(Xrel = abs(Xutm - Xrel_plot), 
         Yrel = abs(Yutm - Yrel_plot))

X_corr <- floor((lm(data = trees_basic |> mutate(plot_code = factor(plot_code)), x ~ Xrel + plot_code) |> summary())$coefficients[,1])
Y_corr <- floor((lm(data = trees_basic |> mutate(plot_code = factor(plot_code)), y ~ Yrel + plot_code) |> summary())$coefficients[,1])

coords_CC <- wf_Paracou_metrics |> select(Plot) |> 
  distinct() |> arrange(Plot) |> 
  left_join(coord_carre_parcelle_paracou |> 
              rowwise() |> 
              mutate(Xrel_plot = min(no_x,ne_x,so_x,se_x), 
                     Yrel_plot = min(no_y,ne_y,so_y,se_y),
                     n_row = max(ne_x,no_x,se_x,so_x) - min(ne_x,no_x,se_x,so_x), 
                     n_col = max(ne_y,no_y,se_y,so_y) - min(ne_y,no_y,se_y,so_y)) |> 
              select(Parc,Xrel_plot,Yrel_plot,n_row,n_col), by = c("Plot" = "Parc")) |> 
  mutate(X_CC = c(abs(X_corr[1]),abs(X_corr[1]) + X_corr[3:16]), 
         Y_CC = c(abs(Y_corr[1]),abs(Y_corr[1]) + Y_corr[3:16])) 

Rel_coords_CC <- wf_Paracou_metrics |> select(wave_ID, Plot,waveID_Plot,lat,lon) |> 
  left_join(coords_CC, by = "Plot") |> 
  mutate(x_rel =  lon - Xrel_plot + X_CC, 
         y_rel = lat - Yrel_plot + Y_CC) |> 
  select(wave_ID, Plot,waveID_Plot,x_rel,y_rel) |> 
  ungroup()



param <- colnames(get_forest(TROLLv3_output))

WIP_CC_data <- trees_basic_withcoord |> filter(paramID == 2065)
Forest_CC <-  as_tibble(matrix(NA,nrow = dim(WIP_CC_data)[1], 
                               ncol = length(param)))
colnames(Forest_CC) <- param
Forest_CC$col <- WIP_CC_data$x ; Forest_CC$row <- WIP_CC_data$y ; Forest_CC$CR <- WIP_CC_data$CR ; Forest_CC$CrownDisplacement <- 0 ;
Forest_CC$height <- WIP_CC_data$height ; Forest_CC$s_name <- WIP_CC_data$species ; Forest_CC$CD <- WIP_CC_data$height * 0.2 ;
Forest_CC$Pmass <- mean(TROLLv3_species$s_Pmass) ; Forest_CC$Nmass <- mean(TROLLv3_species$s_Nmass) ; 
Forest_CC$LMA <- mean(TROLLv3_species$s_LMA) ; Forest_CC$wsg <- mean(TROLLv3_species$s_wsg) ;
Forest_CC$dbhmax <- mean(TROLLv3_species$s_dbhmax); Forest_CC$hmax <- mean(TROLLv3_species$s_hmax) ; 
Forest_CC$dbh <- WIP_CC_data$dbh

Forest_CC <- Forest_CC |>  select( col , row , s_name , CrownDisplacement , Pmass , Nmass , LMA , wsg , Rdark , Vcmax , Jmax , leaflifespan , lambda_young , lambda_mature , lambda_old , dbhmature , dbhmax , hmax , ah , Ct , LAImax , fraction_filled , mult_height , mult_CR , mult_CD , mult_P , mult_N , mult_LMA , mult_dbhmax , dev_wsg , age , dbh , sapwood_area , height , CD , CR , GPP , NPP , Rday , Rnight , Rstem , LAmax , LA , youngLA , matureLA , oldLA , LAI , litter , carbon_storage , carbon_biometry , multiplier_seed , hurt , NPPneg )

Forest_CC <- as.data.frame(Forest_CC)

readr::write_tsv(Forest_CC,"~/Documents/Calib_lidar/Forest_CC.tsv")
readr::write_tsv(Rel_coords_CC,"~/Documents/Calib_lidar/Rel_coords_CC.tsv")
rm(list = ls())
```

```{r}
  sim_CC <- troll(name = "test",path = getwd(),
                  global = generate_parameters(cols = as.numeric(max(Forest_CC$col)+9), rows = as.numeric(max(Forest_CC$row)+11),
                                               iterperyear = 12, nbiter = 6),
                  species = TROLLv3_species,
                  climate = TROLLv3_climatedaytime12,
                  daily = TROLLv3_daytimevar,
                  lidar = generate_lidar(mean_beam_pc = 70,
                                         sd_beam_pc = 35,
                                         klaser_pc = 0.8,
                                         transmittance_laser = 0.05,
                                         iter_pointcloud_generation = 1),
                  
                  forest = Forest_CC,
                  verbose = FALSE)
  
  # information to read in file
  
  dir_current = sim_CC@path
  
  dir.create(file.path(dir_current,"processing_waveforms"))
  
  write.table(Rel_coords_CC|> 
                rename("X" = "x_rel", "Y" = "y_rel") |> 
                select(X,Y,wave_ID), file = file.path(dir_current,"processing_waveforms","list_coords_Paracou_sim.txt"),
              row.names = FALSE,col.names = FALSE)
  
  file_pointcloud_lidR = file.path(dir_current,"test_0.las")
  
  pointcloud_CC <- readLAS(file_pointcloud_lidR)
  projection(pointcloud_CC) <- "EPSG:32622"
  
  writeLAS(filter_poi(filter_duplicates(pointcloud_CC), Z > 0),file.path(dir_current,"processing_waveforms","test_0.las"))
  
  thr <- c(0,2,5,10,15)
  edg <- c(0, 1.5)
  chm <- rasterize_canopy(pointcloud_CC, 1, pitfree(thr, edg))
  
  plot(chm)
  
  if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))
  if(file.exists(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))) file.remove(file.path(dir_current,"processing_waveforms","Paracou.metric.txt"))
  
  wf_pointcloud <-  gediWFSimulator(input = normalizePath(file.path(dir_current,"processing_waveforms","test_0.las")), 
                                    output = paste0(normalizePath(file.path(dir_current,
                                                                            "processing_waveforms")),
                                                    "/gediWF_CC.h5"),
                                    listCoord = normalizePath(file.path(dir_current,
                                                                        "processing_waveforms",
                                                                        "list_coords_Paracou_sim.txt")))
  
  wf_Paracou_metrics<-gediWFMetrics(input=wf_pointcloud,
                                    outRoot=normalizePath(file.path(dir_current,
                                                                    "processing_waveforms", 
                                                                    "Paracou")))
  
  close(wf_pointcloud)
  rm(wf_pointcloud)
  
  if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))
  
  colnames(wf_Paracou_metrics) <- gsub(colnames(wf_Paracou_metrics),pattern = " ",replacement = "_")
  wf_Paracou_metrics$true_ground <- wf_Paracou_metrics$ground_slope <- 0
  readr::write_tsv(wf_Paracou_metrics, file.path(dir_current,"processing_waveforms","Paracou_CC_metric.tsv"))
  rm(wf_Paracou_metrics)
#rm(list = ls())
```

```{r}
dir_current_CC <- paste0(getwd(),"/test")
dir_current <-"~/BETA/backup/Data"
wf_Paracou_metrics_CC <- readr::read_tsv(file.path(dir_current_CC,"processing_waveforms","Paracou_CC_metric.tsv"))
wf_Paracou_metrics <- readr::read_tsv(file.path(dir_current,"processing_waveforms","Paracou_metric.tsv"))

ggplot(tibble(FHD_obs = wf_Paracou_metrics$FHD, FHD_pred = wf_Paracou_metrics_CC$FHD), aes(x = FHD_obs, y = FHD_pred)) + geom_point( ) + 
  geom_abline(slope = 1,intercept = 0)+ xlab(expression(FHD[obs])) + ylab(expression(FHD[pred])) +
  geom_smooth(data = ,method = "lm") + 
  theme_bw()
```

```{r eval=FALSE, include=FALSE}

data("TROLLv3_climatedaytime12")
data("TROLLv3_daytimevar")
data("TROLLv3_species")
. <- NULL
ncores_sim <- 10
dir_current_CC <-"~/Documents/Calib_lidar/"
dir.create(file.path(dir_current_CC,"processing_waveforms"))
dir_current <- paste0(dir_current_CC,"/processing_waveforms")

Forest_CC <- readr::read_tsv("~/Documents/Calib_lidar/Forest_CC.tsv")
grd_Paracou_clipped <- readr::read_tsv("~/Documents/Calib_lidar/grd_Paracou_clipped.tsv")
Rel_coords_CC <- readr::read_tsv("~/Documents/Calib_lidar/Rel_coords_CC.tsv")
  
write.table(Rel_coords_CC|> 
                rename("X" = "x_rel", "Y" = "y_rel") |> 
                select(X,Y,wave_ID), file = file.path(dir_current_CC,"processing_waveforms","list_coords_Paracou_sim.txt"),
              row.names = FALSE,col.names = FALSE)

Xrd <- lhs::randomLHS(n = 500, k = 2) 
Xsim <- tibble(klaser_pc = round(qunif(p = Xrd[,1], min = 0.1,max = 0.9),digits = 2),
               transmittance_laser = round(qunif(p = Xrd[,2], min = 0,max = 0.5), digits = 2)) |> rowwise()|> 
  do(lidar = generate_lidar(mean_beam_pc = 70,
                            sd_beam_pc = 35,
                            klaser_pc = .$klaser_pc,
                            transmittance_laser = .$transmittance_laser,
                            iter_pointcloud_generation = 0)) |> 
  unnest(cols = c(lidar)) |> 
  mutate(simulation = paste0("sim_",as.character(ceiling(row_number()/5))))




nrep <- tibble(Sim_ID = unique(Xsim$simulation)) %>% 
  mutate(ID_iter = ceiling(row_number()/ncores_sim))

for (blocki in (1):max(nrep$ID_iter)) {
  WIP_folder_PATH = tempdir()
  
  simulations <- as.character(unlist(nrep %>%
                                       filter(ID_iter == ( blocki)) %>% 
                                       dplyr::select(Sim_ID)))
  
  
  cat(paste0("Computing TROLL initial simulation # ", blocki , " / ", max(nrep$ID_iter), " ",
             gsub(":", "-",
                  gsub(
                    " ", "_",
                    timestamp(
                      prefix = "",
                      suffix = "",
                      quiet = T
                    )
                  )),"\n"))
  
  gc()
  
  sim_CC <- stack(name = "sim_stack",path = WIP_folder_PATH,
                  simulations = simulations,
                  global = generate_parameters(cols = as.numeric(max(Forest_CC$col)+9), 
                                               rows = as.numeric(max(Forest_CC$row)+11),
                                               iterperyear = 12, nbiter = 0),
                  species = TROLLv3_species,
                  climate = TROLLv3_climatedaytime12,
                  daily = TROLLv3_daytimevar,
                  lidar = as.data.frame(Xsim %>% 
                                          filter(simulation %in% simulations)) ,
                  forest = Forest_CC,
                  cores = ncores_sim,
                  overwrite = TRUE,
                  verbose = FALSE)
  
  cat(paste0("Extracting TROLL WF simulations # ", blocki , " / ", max(nrep$ID_iter), " ",
             gsub(":", "-",
                  gsub(
                    " ", "_",
                    timestamp(
                      prefix = "",
                      suffix = "",
                      quiet = T
                    )
                  )),"\n"))
  
  
  cl <- parallel::makeCluster(ncores_sim, outfile = "")
  #Register cluster
  registerDoSNOW(cl)
  pb <- txtProgressBar(max = length(simulations), style = 3)
  progress <- function(n) setTxtProgressBar(pb, n)
  opts <- list(progress = progress)
  
  stack_res <- foreach(i=simulations,
                       .packages = c("rGEDI", "lidR"),
                       .combine = rbind,
                       .inorder = TRUE,.options.snow = opts) %dopar% {
                         DB_las <- normalizePath(paste0(WIP_folder_PATH,"/sim_stack/",i,"/",i,"_0.las"))
                         
                         if(file.exists(file.path(WIP_folder_PATH,"processing_waveforms",paste0("gediWF_",i,"_CC.h5")))) file.remove(file.path(WIP_folder_PATH,"processing_waveforms",paste0("gediWF_",i,"_CC.h5")))
                         if(file.exists(file.path(WIP_folder_PATH,
                                                  "processing_waveforms", 
                                                  paste0("Paracou_",i,".metric.txt")))) file.remove(file.path(WIP_folder_PATH,"processing_waveforms","Paracou.metric.txt"))
                         
                         wf_pointcloud <-  gediWFSimulator(input = DB_las, 
                                                           output = paste0(normalizePath(file.path(WIP_folder_PATH)),
                                                                           paste0("/gediWF_",i,"_CC.h5")),
                                                           listCoord = normalizePath(file.path(dir_current_CC,
                                                                                               "processing_waveforms",
                                                                                               "list_coords_Paracou_sim.txt")))
                         
                         wf_Paracou_metrics<-gediWFMetrics(input=wf_pointcloud,
                                                           outRoot=normalizePath(file.path(WIP_folder_PATH,
                                                                                    paste0("Paracou_",i))))
                         
                         close(wf_pointcloud)
                         rm(wf_pointcloud)
                         
                         if(file.exists(file.path(WIP_folder_PATH,"processing_waveforms",paste0("gediWF_",i,"_CC.h5")))) file.remove(file.path(WIP_folder_PATH,"processing_waveforms",paste0("gediWF_",i,"_CC.h5")))
                         
                         colnames(wf_Paracou_metrics) <- gsub(colnames(wf_Paracou_metrics),pattern = " ",replacement = "_")
                         wf_Paracou_metrics$true_ground <- wf_Paracou_metrics$ground_slope <- 0
                         readr::write_tsv(wf_Paracou_metrics, file.path(dir_current_CC,"processing_waveforms",paste0("Paracou_CC_",i,"metric.tsv") ))
                         rm(wf_Paracou_metrics)
                         
                         
                       }
  close(pb)
  stopCluster(cl)
  
  
  unlink(WIP_folder_PATH)
  
}

```


```{r}
files_to_read <- paste0("~/Documents/Calib_lidar/processing_waveforms/raw/",list.files("~/Documents/Calib_lidar/processing_waveforms/raw/"))
all_files <- lapply(files_to_read,function(x) {
   read.table(file = x, 
              sep = '\t', 
              header = TRUE)
}) |> dplyr::bind_rows()


```


# References

-   Knapp, N., Huth, A., & Fischer, R. (2021). Tree Crowns Cause Border Effects in Area-Based Biomass Estimations from Remote Sensing. *Remote Sensing*, *13(8)*, Article 8. <https://doi.org/10.3390/rs13081592>
-   Fischer, F. J., Labrière, N., Vincent, G., Hérault, B., Alonso, A., Memiaghe, H., Bissiengou, P., Kenfack, D., Saatchi, S., & Chave, J. (2020). A simulation method to infer tree allometry and forest structure from airborne laser scanning and forest inventories. *Remote Sensing of Environment*, *251*, 112056. <https://doi.org/10.1016/j.rse.2020.112056>
