---
title: "ALS lidar simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ALS lidar simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6,
  fig.width = 6
)
```

This vignette gives a quick example of a simple workflow to produce discrete lidar LAS and full waveform GEDI lidar from TROLL simulation.

# Setup

We will use `rcontroll`.

```{r libs, eval=FALSE, include=TRUE}
suppressMessages(library(dplyr))
library(tidyr)
library(ggplot2)
suppressMessages(library(rcontroll))
library(lidR)
library(plot3D)
library(terra)
library(sf)
library(rGEDI)
```

# Lidar simulation

A Lidar slot is added to TROLL simulation if lidar simulation parameters are specified.

```{r, eval=FALSE, include=TRUE}

sim <- troll(name = "test",path = getwd(),
             global = generate_parameters(cols = 100, rows = 100,
                                          iterperyear = 12, nbiter = 12*600),
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar,lidar = generate_lidar(mean_beam_pc = 10,
                                                               sd_beam_pc = 5,
                                                               klaser_pc = 0.63,
                                                               transmittance_laser = 0.1,
                                                               iter_pointcloud_generation = 12*600-1),
             verbose = FALSE)

# information to read in file

dir_current = sim@path

```

The generated lidar simulation provide standard paramters to simulate las. But the iter of the lidar simulation must be specified using : iter_pointcloud_generation

The las file is produced in the same folder as other outputs files.

It can be read as a typical las file.

```{r, eval=FALSE, include=TRUE}
# read files
file_pointcloud = file.path(dir_current,"test_0.las")

# read in file
pointcloud = readLAS(file_pointcloud)
pointcloud@header # check format
pointcloud@data   # check format

# plot
plot(pointcloud)

# rGEDI needs the las files reexported temporarily (maybe to update format)
file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","test_0.las")
dir.create(file.path(dir_current,"processing_waveforms"))

writeLAS(pointcloud, file_pointcloud_lidR)
```

The rGEDI package allows to process ALS las data to simulate a Full Waveform signal equivalent to data collected by GEDI Device on ISS.

```{r, eval=FALSE, include=TRUE}
# rGEDI is not on CRAN anymore, github installation did not work for me, but it worked with a download of the last available CRAN version (https://cran.r-project.org/src/contrib/Archive/rGEDI/)
# install.packages(pkgs="~/Downloads/rGEDI_0.1.11.tar.gz", type="source", repos=NULL) # worked
# library(devtools)
# devtools::install_git("https://github.com/carlos-alberto-silva/rGEDI", dependencies = TRUE) # did not work


# now generate GEDI footprint
# cf. https://github.com/carlos-alberto-silva/rGEDI
# Extracting plot center geolocations

file_pointcloud_lidR = file.path(dir_current,"processing_waveforms","test_0.las")

pointcloud = readLAS(file_pointcloud_lidR)

# we calculate waveform for a specific point within the simulated extent
wv_x_pointcloud = 50
wv_y_pointcloud = 50

# remove files, as gediWFSimulator does not overwrite
if(file.exists(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))) file.remove(file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"))

wf_pointcloud = gediWFSimulator(input = file_pointcloud_lidR, output = file.path(dir_current,"processing_waveforms","gediWF_simulation.h5"), coords = c(wv_x_pointcloud, wv_y_pointcloud))

waveform_extent = st_point(x = c(wv_x_pointcloud, wv_y_pointcloud), dim = "XYZ") |> 
  st_buffer(dist = 12.5)# bit awkward, using terra, then sf
pointcloud_clipped = clip_roi(pointcloud, waveform_extent)

par(mfrow=c(1,2), mar=c(4,4,1,1), oma=c(1,1,1,1),cex.axis = 1.2)
scatter3D(pointcloud_clipped@data$X,pointcloud_clipped@data$Y,pointcloud_clipped@data$Z,pch = 16,colkey = FALSE, main="ALS simulation (realistic extinction)",
          cex = 0.5,bty = "u",col.panel ="gray90",phi = 30,alpha=1,theta=45,
          col.grid = "gray50", xlab="UTM Easting (m)", ylab="UTM Northing (m)", zlab="Elevation (m)")

plot(wf_pointcloud, relative=TRUE, polygon=TRUE, type="l", lwd=2, col="forestgreen",
     xlab="", ylab="Elevation (m)", ylim=c(0,70))

```

Using this workflow, a TROLL forest is now associated to a simulated FW signal and las point cloud.

On the other hand, the 3D LAI Field can be converted to FW according to (Knapp et al., 2021).

```{r, eval=FALSE, include=TRUE}
library(tidyverse)

test_0_LAI3D<- read.delim(paste0(dir_current,"/test_0_LAI.txt"))

LAI_WF <- test_0_LAI3D |>  mutate(LAD = LAI3D - lead(LAI3D)) |>  
  filter(LAD>0 | h==0) |> mutate(Intensity = if_else(h==0, 
                                                     exp(-0.2*LAI3D - ((row - 50)^2 + (col - 50)^2)/( 2 * 5.5^2))/2.5,
                                                     exp(-0.2*LAI3D - ((row - 50)^2 + (col - 50)^2)/( 2 * 5.5^2)))) |> 
  group_by(h) |>  summarize(I = sum(Intensity)) |> ungroup() |>  mutate(I = I/sum(I))

LAI_WF_sample <- sample(LAI_WF$h,size = 100000, prob = LAI_WF$I,replace = TRUE) |> density(kernel = "gaussian")



ggplot() + geom_line(data = tibble(h = LAI_WF_sample$x,WF = LAI_WF_sample$y),aes(x = h, y=WF)) + 
  geom_line(data = LAI_WF,aes(x = h, y = I/sum(I)), col = "red") + 
  coord_flip() + theme_bw()


```

# Calibration ALS / GEDI Full Waveform

Using Canopy Constructor to reconstruct experimental standard plots, lidar module is calibrated to reproduce observed GEDI full waveform on theses plots.

```{r, eval=FALSE, include=TRUE}
dir_current = paste0(getwd(),"/Calib_ALS")
dir.create(file.path(getwd(),"Calib_ALS"))
dir.create(file.path(dir_current,"Calib_ALS/processing_waveforms"))
```


We retrieve GEDI data with gedifinder from rGEDI and clip using experimental site extent.

```{r, eval=FALSE, include=TRUE}
library(rGEDI)
library(rgdal)
library(doSNOW)
library(parallel)
library(foreach)

lr_lat<-  5.2523938253350169
ul_lat<-  5.2841143966432611

lr_lon <- -52.9156833764840400
ul_lon <- -52.9429150172853937

# Specifying the date range
daterange= c("2021-05-01","2022-10-01")

# Get path to GEDI data
gLevel1B<-gedifinder(product="GEDI01_B",ul_lat, ul_lon, lr_lat, lr_lon,version="002",daterange=daterange)
gLevel2A<-gedifinder(product="GEDI02_A",ul_lat, ul_lon, lr_lat, lr_lon,version="002",daterange=daterange)
gLevel2B<-gedifinder(product="GEDI02_B",ul_lat, ul_lon, lr_lat, lr_lon,version="002",daterange=daterange)

outdir=tempdir()
dir.create(paste0(file.path(dir_current,"processing_waveforms"),"/Clipped"))

DDL_GEDI <- c(gLevel1B,gLevel2A,gLevel2B)

Type_GEDI <- c(rep("1B", times = length(gLevel1B)),
               rep("2A", times = length(gLevel2A)),
               rep("2B", times = length(gLevel2B)))

gediDownload(filepath=DDL_GEDI,outdir=outdir)

polygon_filepath <- "D:/PhD/SIG/Plots/Paracou_plots.shp"

polygon_spdf<-readOGR(polygon_filepath) |> sf::st_as_sf() |> sf::st_transform("EPSG:4326") |> sf::as_Spatial()

i <- NULL
cl <- makeCluster(1, outfile = "")
registerDoSNOW(cl)
pb <- txtProgressBar(max = length(DDL_GEDI), style = 3)
progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)
foreach(i=1:length(DDL_GEDI), .packages = c("rGEDI"),
        .options.snow = opts) %dopar% {

          Sys.sleep(runif(1,1,10))

          file_id <- strsplit(DDL_GEDI[i], split = "/")[[1]][9]


          # xmin = -52.9429150172853937
          # xmax = -52.9156833764840400
          # ymin = 5.2523938253350169
          # ymax = 5.2841143966432611

          if (Type_GEDI[i]=="1B") {
            gedilevel1b<-readLevel1B(level1Bpath = paste0(outdir,"/",file_id))
            clipLevel1BGeometry(gedilevel1b, polygon_spdf,
                        output=paste0(file.path(dir_current,"processing_waveforms"),
                                                                          "/Clipped/Clipped_",file_id))
            close(gedilevel1b)
          }

          if (Type_GEDI[i]=="2A") {
            gedilevel2a<-readLevel2A(level2Apath = paste0(outdir,"/",file_id))
            clipLevel2AGeometry(gedilevel2a, polygon_spdf, 
                        output=paste0(file.path(dir_current,"processing_waveforms"),
                                      "/Clipped/Clipped_",file_id))
            close(gedilevel2a)
          }
          if (Type_GEDI[i]=="2B") {
            gedilevel2b<-readLevel2B(level2Bpath = paste0(outdir,"/",file_id))
            clipLevel2BGeometry(gedilevel2b,polygon_spdf,
                        output=paste0(file.path(dir_current,"processing_waveforms"),
                                      "/Clipped/Clipped_",file_id))
            close(gedilevel2b)
          }



          

        }
close(pb)
stopCluster(cl)

unlink(x = outdir)

```



# References

 * Knapp, N., Huth, A., & Fischer, R. (2021). Tree Crowns Cause Border Effects in Area-Based Biomass Estimations from Remote Sensing. Remote Sensing, 13(8), Article 8. https://doi.org/10.3390/rs13081592
