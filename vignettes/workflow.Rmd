---
title: "Simulation workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 8,
  fig.width = 8
)
```

# Libraries

```{r libs}
library(dplyr)
library(tidyr)
library(rcontroll)
iters <- 10
```


# Generate parameters

```{r genPar}
generate_parameters(cols = 400, rows = 400) %>% 
  head()
```

# Simulations

## Data

```{r datasim}
data("TROLLv3_input")
data("TROLLv3_species")
data("TROLLv3_climatedaytime12")
data("TROLLv3_climatedaytime365")
data("TROLLv3_daytimevar")
TROLLv3_input$value[5] <- iters # iterations
```

## Full

```{r fullsim}
sim <- troll(name = "test",
             # path = "./",
             full = TRUE,
             abc = FALSE, 
             random = TRUE,
             global = TROLLv3_input,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
sim
```

```{r fullsimG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("abund", "agb"), 
         species = "total")
```

```{r fullsimG2}
autoplot(sim, what = "final pattern")
```

## Reduced

```{r reducedsim}
sim <- troll(name = "test1",
             overwrite = TRUE,   
             # path = "./",
             full = FALSE,
             abc = FALSE, 
             random = TRUE,
             global = TROLLv3_input,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
sim
```

```{r reducedsimG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("N", "AGB"), 
         species = "total")
```

# Stacks

## Data

```{r datastack}
library(rcontroll)
data("TROLLv3_input")
data("TROLLv3_species")
data("TROLLv3_climatedaytime12")
data("TROLLv3_climatedaytime365")
data("TROLLv3_daytimevar")
TROLLv3_input$value[5] <- iters # iterations
TROLLv3_input_stack <- TROLLv3_input %>% 
  mutate(simulation = list(c("seed50000", "seed500"))) %>% 
  unnest(simulation)
TROLLv3_input_stack[62,2] <- 500 # Cseedrain
```

## Full

```{r fullstack}
sim <- stack(name = "test3", 
             simulations = c("seed50000", "seed500"),
             # path = "/home/sylvain/Documents/ECOFOG/rcontroll",
             full = TRUE,
             abc = FALSE,
             random = TRUE,
             global = TROLLv3_input_stack,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
sim
```

```{r fullstackG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("abund", "agb"), 
         species = "total")
```

```{r fullstackG2}
autoplot(sim, what = "final pattern")
```

## Reduced

```{r reducedstack}
sim <- stack(name = "test",
             simulations = c("seed50000", "seed500"),
             # path = "/home/sylvain/Documents/ECOFOG/rcontroll",
             full = FALSE,
             abc = FALSE, 
             random = TRUE,
             global = TROLLv3_input_stack,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
sim
```

```{r reducedstackG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("N", "AGB"), 
         species = "total")
```
