---
title: "A simple workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{A simple workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6,
  fig.width = 6
)
```

This vignette gives a quick example of a simple workflow to produce a single simulation, a stack of simulations, or start from an existing inventory or a previous simulation.

# Setup

We will use packages `rcontroll` and `dplyr` and `tidyr` for data wrangling.

```{r libs}
library(dplyr)
library(tidyr)
library(ggplot2)
library(rcontroll)
```

# Data

We load the species data available for French Guiana (`TROLLv3_species`), with associated climate data (`TROLLv3_climatedaytime12`) and day variation (`TROLLv3_daytimevar`). We generate parameters using `generate_parameters` for a simulation per month (`iterperyear` = 12) lasting one year (`nbiter` = 12). We further duplicated parameters with a simulation index using `mutate` and `unnest` for a stack of simulations using a `seedrain` of 5000 (default) and 500 (default/10). 

```{r data}
data("TROLLv3_species")
data("TROLLv3_climatedaytime12")
data("TROLLv3_daytimevar")
data("TROLLv3_output")
TROLLv3_input_stack <- generate_parameters(cols = 100, rows = 100,
                                           iterperyear = 12, nbiter = 12*1) %>% 
  mutate(simulation = list(c("seed50000", "seed500"))) %>% 
  unnest(simulation)
TROLLv3_input_stack[62,2] <- 500 # Cseedrain
```

# Generate parameters

We can generate parameters and view them directly as a table with a description of its effect using `generate_parameters` and `kable`.

```{r genPar}
generate_parameters(cols = 250, rows = 250) %>% 
  head() %>% 
  knitr::kable()
```

# Simple simulation

We run a simple simulation using the `troll` function with loaded and generated data. If `verbose` is not inactivated, we have the TROLL log directly in the console.

```{r troll}
sim <- troll(name = "test",
             global = generate_parameters(cols = 100, rows = 100,
                                          iterperyear = 12, nbiter = 12*1),
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
```

We can print a quick simple summary of the simulation.

```{r}
sim
```

We can quickly plot temporal trajectories using `autoplot` and `what` defined on ecosystem, for instance here with number of stems (abund) and basal area (ba) for 4 species: *Cecropia obtusa, Dicorynia guianensis, Eperua grandiflora,* and *Vouacapoua americana*.

```{r fullsimG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("ba", "agb"))
```

Similarly, we can quickly plot the final patterns using `autoplot` and `what` defined on final pattern.

```{r fullsimG2}
autoplot(sim, what = "forest")
```

```{r fullsimG3}
autoplot(sim, what = "species", 
         variables = c("agb", "ba"),
          # variables = names(sim@ecosystem)[-1],
         species = c("Cecropia_obtusa","Dicorynia_guianensis","Eperua_grandiflora","Vouacapoua_americana")) 
```

# Stack of simulations

We run a stack of simulations using the `stack` function with loaded and generated data.
We can inactivate `verbose` to see only the loading bar.
We can define the number of cores used for parrallelization.
And we can define a thinning of outputs by giving the number of iterations to be kept to reduce the output size.

```{r fullstack}
sim_stack <- stack(name = "teststack", 
             simulations = c("seed50000", "seed500"),
             # path = "../",
             global = TROLLv3_input_stack,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar,
             verbose = F,
             cores = 2,
             thin = c(1,5,10))
```

We can print a quick simple summary of the simulations.

```{r}
sim_stack
```

We can quickly plot temporal trajectories for all simulations using `autoplot` and `what` defined on ecosystem, for instance here with number of stems (abund) and basal area (ba) for 4 species: *Cecropia obtusa, Dicorynia guianensis, Eperua grandiflora,* and *Vouacapoua americana*.

```{r fullstackG1}
autoplot(sim_stack, 
         what = "ecosystem", 
         variables = c("ba", "agb"))
```

Similarly, we can quickly plot the final patterns for all simulations using `autoplot` and `what` defined on final pattern.

```{r fullstackG2}
autoplot(sim_stack, what = "forest")
```

```{r fullstackG3}
autoplot(sim_stack, what = "species", variables = "agb",
         species = c("Cecropia_obtusa","Dicorynia_guianensis","Eperua_grandiflora","Vouacapoua_americana"))
```

# From a forest

```{r}
autoplot(TROLLv3_output, what = "ecosystem")
```

```{r}
autoplot(TROLLv3_output, what = "forest")
```

```{r }
forest_init <- filter(TROLLv3_output@forest, 
       iter == max(TROLLv3_output@forest$iter)) %>% 
  dplyr::select(-iter, -from_Data, -sp_lab, -site, -dbh_previous, -AGB) %>% 
  as.data.frame()
global_pars <- TROLLv3_output@inputs$global
global_pars[which(global_pars$param == "nbiter"),2] <- 12*1
sim <- troll(name = "test",
             # path = "/home/sylvain/Documents/ECOFOG/rcontroll/",
             global = global_pars,
             species = TROLLv3_output@inputs$species,
             climate = TROLLv3_output@inputs$climate,
             daily = TROLLv3_output@inputs$daily,
             forest = forest_init)
sim@ecosystem$iter <- sim@ecosystem$iter + max(TROLLv3_output@ecosystem$iter)
```

```{r}
list("TROLLv3_output" = TROLLv3_output@ecosystem,
     "sim" = sim@ecosystem) %>% 
  bind_rows(.id = "sim") %>% 
  ggplot(aes(iter, agb, col = sim)) +
  geom_point() +
  theme_bw()
```
