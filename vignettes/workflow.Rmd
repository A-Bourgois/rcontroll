---
title: "A simple workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{A simple workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6,
  fig.width = 6
)
```

# Setup

```{r libs}
library(dplyr)
library(tidyr)
library(rcontroll)
Nyears <- 1
data("TROLLv3_input")
data("TROLLv3_species")
data("TROLLv3_climatedaytime12")
data("TROLLv3_daytimevar")
TROLLv3_input$value[6] <- 12 # Nb iterations per Year
TROLLv3_input$value[5] <- Nyears*12 # iterations
TROLLv3_input_stack <- TROLLv3_input %>% 
  mutate(simulation = list(c("seed50000", "seed500"))) %>% 
  unnest(simulation)
TROLLv3_input_stack[62,2] <- 500 # Cseedrain
```


# Generate parameters

```{r genPar}
generate_parameters(cols = 250, rows = 250) %>% 
  head() %>% 
  knitr::kable()
```

# Simple simulation

```{r fullsim}
sim <- troll(name = "test",
             path = "../",
             global = generate_parameters(OUTPUT_reduced = 0, NONRANDOM = 0, FromData = 0),
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar)
```

```{r}
sim
```

```{r fullsimG1}
autoplot(sim, 
         what = "ecosystem", 
         variables = c("abund", "ba"), 
         selected_species = c("Cecropia_obtusa","Dicorynia_guianensis","Eperua_grandiflora","Vouacapoua_americana"))
```

```{r fullsimG2}
autoplot(sim, what = "final pattern")
```

# Stack of simulations

```{r fullstack}
sim_stack <- stack(name = "test3", 
             simulations = c("seed50000", "seed500"),
             # path = "../",
             global = TROLLv3_input_stack,
             species = TROLLv3_species,
             climate = TROLLv3_climatedaytime12,
             daily = TROLLv3_daytimevar,
             cores = 2,
             thin = c(1,5,10))
```

```{r}
sim_stack
```

```{r fullstackG1}
autoplot(sim_stack, 
         what = "ecosystem", 
         variables = c("abund", "agb"), 
         selected_species = c("Cecropia_obtusa","Dicorynia_guianensis","Eperua_grandiflora","Vouacapoua_americana"))
```

```{r fullstackG2}
autoplot(sim_stack, what = "final pattern")
```
